name: NFTopia Stellar CI

on:
  push:
    paths:
      - 'nftopia-stellar/**'
  pull_request:
    paths:
      - 'nftopia-stellar/**'

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./nftopia-stellar

    steps:
    - uses: actions/checkout@v3
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        components: rustfmt, clippy
    
    - name: Install Soroban CLI
      run: |
        curl -sSL https://github.com/stellar/soroban-cli/releases/download/v0.11.1/soroban-cli-0.11.1-x86_64-unknown-linux-gnu.tar.gz | sudo tar -xz -C /usr/local/bin
    
    - name: Cache cargo registry
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          ./nftopia-stellar/target
        key: ${{ runner.os }}-cargo-${{ hashFiles('./nftopia-stellar/Cargo.lock') }}
    
    - name: Check formatting
      run: cargo fmt -- --check || true
    
    - name: Run clippy
      run: cargo clippy --target wasm32-unknown-unknown -- -D warnings || true
    
    - name: Build contracts
      run: cargo build --target wasm32-unknown-unknown --release
    
    - name: Run tests
      run: cargo test --target wasm32-unknown-unknown || true
    
    - name: Build all contracts
      run: |
        for dir in contracts/*/; do
          if [ -f "$dir/Cargo.toml" ]; then
            echo "Building contract in $dir"
            (cd "$dir" && cargo build --target wasm32-unknown-unknown --release || echo "Build failed for $dir")
          fi
        done
    
    - name: Optimize WASM
      run: |
        # Install soroban contract optimizor if needed
        cargo install --locked --version 0.11.1 soroban-cli
        find ./target/wasm32-unknown-unknown/release -name "*.wasm" -type f | while read wasm; do
          echo "Optimizing $wasm"
          soroban contract optimize --wasm "$wasm" --wasm-out "${wasm%.wasm}_optimized.wasm"
        done

  deploy-testnet:
    needs: check
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./nftopia-stellar

    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
          targets: wasm32-unknown-unknown
      
      - name: Verify Rust project
        run: |
          if [ ! -f "Cargo.toml" ]; then
            echo "❌ ERROR: No Cargo.toml file found"
            exit 1
          fi
          echo "✅ Rust project verified"
      
      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
      
      - name: Check formatting
        run: cargo fmt -- --check
      
      - name: Run clippy
        run: cargo clippy -- -D warnings
      
      - name: Check build
        run: cargo check --verbose
        continue-on-error: false
      
      - name: Run tests
        run: cargo test --verbose
      
      - name: Build WASM contracts
        run: cargo build --target wasm32-unknown-unknown --release